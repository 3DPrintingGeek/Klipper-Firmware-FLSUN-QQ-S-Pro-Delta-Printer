# Klipper config file for stock QQ-S Pro:

# Mesh bed leveling is also added, but commented out. Only enable it if
# running the PROBE_ACCURACY command outputs a range value < 0.025 mm

# Note that an offset probe is not recommended on delta printers due to
# effector tilt. In order to use it successfully to create a useable bed mesh
# you need to run the enhanced delta calibration:
# https://www.klipper3d.org/Delta_Calibrate.html

# See docs/Config_Reference.md for a description of parameters.

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command
baud: 250000

[printer]
kinematics: delta
max_velocity: 500
max_accel: 2000
max_z_velocity: 200
minimum_z_position: -5
delta_radius: 130

[stepper_a]
step_pin: PE3
dir_pin: PE2
enable_pin: !PE4
rotation_distance: 32
endstop_pin: PA15
microsteps: 16
homing_speed: 60
position_endstop: 370
arm_length: 280.0

[stepper_b]
step_pin: PE0
dir_pin: PB9
enable_pin: !PE1
rotation_distance: 32
endstop_pin: PA12
microsteps: 16

[stepper_c]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB8
rotation_distance: 32
endstop_pin: PC4
microsteps: 16

[probe]
pin: !PA11
x_offset: 0
y_offset: 0
z_offset: 10
samples: 3
samples_result: average
sample_retract_dist: 5
speed: 20 #helps with consistency of probing.

[delta_calibrate]
radius: 120
horizontal_move_z: 10
speed: 20 #ensure accurate probing

[extruder]
step_pin: PD6
dir_pin: !PD3
enable_pin: !PB3
rotation_distance: 9
microsteps: 16
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC3
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
control: pid
pid_Kp: 14.529
pid_Ki: 0.557
pid_Kd: 94.802
min_extrude_temp: 180
min_temp: 0
max_temp: 260
#max_extrude_only_accel: 250 setting this can help with the whine of the extruder. Play around with this number.

[heater_bed]
heater_pin: PA0
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC0
control: pid
pid_Kp: 325.10
pid_Ki: 63.35
pid_Kd: 417.10
min_temp: 0
max_temp: 150

[fan]
pin: PB1
kick_start_time: 0.200

#Allows you to see your MCU temps on the graph
[temperature_sensor mcu_temp]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100

#Allows you to see your Raspberry Pi CPU temps on the graph
[temperature_sensor raspberry_pi]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

#######################################################################
# Optional: Bed mesh leveling - only use if the PROBE_ACCURACY
#                               command outputs a range value < 0.025 mm
#######################################################################

#[bed_mesh]
#speed: 50
#horizontal_move_z: 5
#mesh_radius: 100
#mesh_origin: 0,0
#round_probe_count: 5
#algorithm: lagrange

#######################################################################
# Optional: End-stop style filament sensor
#######################################################################

#[filament_switch_sensor Filament]
#pause_on_runout: True
#switch_pin: PA4

#######################################################################
# Optional: BL Touch Probe - comment out [probe] section if using this
#######################################################################

#[bltouch]
#sensor_pin: PA11
#control_pin: PA8
#stow_on_each_sample: True
#set_output_mode: 5V
#x_offset: 3
#y_offset: -36
#z_offset: -2.3
#samples: 3
#sample_retract_dist: 5
#samples_result: average

#######################################################################
# Clears screen so it is off
#######################################################################

[static_digital_output display_reset]
pins: !PC6, !PD13

#######################################################################
# Fairly quiet settings without running stealthchop if you have TMC2209 Drivers. Likely works with 2208 but has not been tested.
#######################################################################

[tmc2209 stepper_a]
#uart_pin: PA10 commented so you have to check which pins are connected to which steppers.
run_current: .850
hold_current: .500
interpolate: True
stealthchop_threshold: 0

[tmc2209 stepper_b]
#uart_pin: PA9
run_current: .850
hold_current: .500
interpolate: True
stealthchop_threshold: 0

[tmc2209 stepper_c]
#uart_pin: PC7
run_current: .850
hold_current: .500
interpolate: True
stealthchop_threshold: 0

[tmc2209 extruder]
#uart_pin: PA8
interpolate: True
run_current: .850
hold_current: .500
stealthchop_threshold: 0

#[endstop_phase]
# Please read (the Endstop Phase Documentation)[https://www.klipper3d.org/Endstop_Phase.html]


# This is the path where your g-code files will be uploaded to in the
# rasbperry pi
[virtual_sdcard]
path: ~/gcode_files

[display_status]

[pause_resume]

[respond] # See (the klipper docs)[https://github.com/KevinOConnor/klipper/blob/master/docs/G-Codes.md#send-message-respond-to-host] for more info.

#[include client_macros.cfg] Adding this line will allow you to keep your macros in a seperate file to keep the main printer.cfg file as clean as possible.

# This macro should be called at the 'start g-code' part
# of your slicer and you would put all the start g-code here
# instead so that you don't have to re-slice everytime you
# have to edit the commands
[gcode_macro START_PRINT]
gcode:
    M117 Homing...
    # Use absolute coordinates
    G90
    # Reset the G-Code Z offset (adjust Z offset if needed)
    SET_GCODE_OFFSET Z=0
    # Home the printer
    G28
    # Use the bed mesh
    {% if params.T_BED|int == 60 %}
        #BED_MESH_PROFILE LOAD="60C_bare"
        SET_GCODE_OFFSET Z=0.045 MOVE=0
        M118 Printing PLA.
        #M117 Printing PLA, loaded bed mesh.
    {% elif params.T_BED|int == 80 %}
        #BED_MESH_PROFILE LOAD="80C_tape"
        SET_GCODE_OFFSET Z=0.320 MOVE=0
        M118 Printing PETG.
        #M117 Printing PETG, loaded bed mesh.
    {% elif params.T_BED|int == 110 %}
        #BED_MESH_PROFILE LOAD="110C_bare"
        SET_GCODE_OFFSET Z=0.030 MOVE=0
        M118 Printing ABS.
        #M117 Printing ABS, loaded bed mesh.
    {% else %}
        M117 No bed mesh loaded!
    {% endif %}

    ### SET HB/HE AND WAIT
    M190 S{params.T_BED}
    M109 S{params.T_EXTRUDER}
    M117 Bed and Nozzle heated.
    ### CALL NOZZLE PRIME MACRO
    PRIME_NOZZLE

[gcode_macro PRIME_NOZZLE]
gcode:
    ### Prime line routine
    M117 Printing prime line.
    ### RESET EXTRUSION DISTANCE
    G92 E0.0
    ### go outside print area
    G1 X-54.672 Y-95.203 Z0.3 F4000
    ### RESET EXTRUSION DISTANCE
    G92 E0.0
    ### DERETRACT AND OOZE
    G1 E2 F1000
    G3 X38.904 Y-102.668 I54.672 J95.105 E20.999
    G3 X54.671 Y-95.203 I-38.815 J102.373 E4.5
    G92 E0.0
    ### RETRACT 5MM AND 3X WIPE
    G1 E-1 F3000
    G1 X52.931 Y-96.185 F1000
    G1 X50.985 Y-97.231 F1000
    G1 X49.018 Y-98.238 F1000
    G1 X0 Y-109.798 F1000
    ### DE-RETRACT
    G1 E4.8 F1500
    ### RESET EXTRUSION DISTANCE
    G92 E0.0
    ### FINAL PRINT ADJS
    M117 Preparing to print
    ### M221 S95
    M117 Printing started...
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=60
    
[gcode_macro END_PRINT]
gcode:
    SET_GCODE_OFFSET Z=0 # resets the z-offset (otherwise, the offsets stack)

    ### Turn off bed, extruder, and fan
    M140 S0
    M104 S0
    M106 S0
    # disable bed mesh
    BED_MESH_CLEAR
    ### Move nozzle away from print while retracting
    G91
    ### Raise nozzle by 10mm
    G1 Z200 E-5 F3000
    G90
    G1 X0 Y0 F3000
    ### Disable steppers
    M84
    M117 Done Printing
    UPDATE_DELAYED_GCODE ID=clear_display DURATION=40

# Pause print macro
[gcode_macro PAUSE]
rename_existing: BASE_PAUSE
default_parameter_X: 220    #edit to your park position
default_parameter_Y: 220    #edit to your park position
default_parameter_Z: 10     #edit to your park position
default_parameter_E: 1      #edit to your retract length
gcode:
    SAVE_GCODE_STATE NAME=PAUSE_state
    BASE_PAUSE
    G91
    G1 E-{E} F2100
    G1 Z{Z}
    G90
    G1 X{X} Y{Y} F6000

# Resume print macro
[gcode_macro RESUME]
rename_existing: BASE_RESUME
default_parameter_E: 1      #edit to your retract length
gcode:
    G91
    G1 E{E} F2100
    G90
    RESTORE_GCODE_STATE NAME=PAUSE_state MOVE=1
    BASE_RESUME

# Cancel print macro
[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
gcode:
    TURN_OFF_HEATERS
    CLEAR_PAUSE
    SDCARD_RESET_FILE
    BASE_CANCEL_PRINT

[delayed_gcode clear_display]
gcode:
    M117
